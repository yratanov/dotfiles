#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
USERNAME="${USER}"

# Logging with colors
info()  { printf '\033[1;34m[INFO]\033[0m %s\n' "$1"; }
warn()  { printf '\033[1;33m[WARN]\033[0m %s\n' "$1"; }
error() { printf '\033[1;31m[ERROR]\033[0m %s\n' "$1" >&2; }
success() { printf '\033[1;32m[OK]\033[0m %s\n' "$1"; }

# Idempotent git clone
clone_if_missing() {
    local repo="$1" dest="$2" branch="${3:-}"
    if [[ -d "$dest" ]]; then
        info "Already exists: $dest"
    else
        info "Cloning $repo to $dest"
        if [[ -n "$branch" ]]; then
            git clone -b "$branch" "$repo" "$dest"
        else
            git clone "$repo" "$dest"
        fi
        success "Cloned $repo"
    fi
}

install_yay() {
    info "Checking for yay..."
    if command -v yay &>/dev/null; then
        info "yay is already installed"
        return 0
    fi

    info "Installing yay..."
    sudo pacman -Syu --needed --noconfirm git base-devel

    local temp_dir
    temp_dir="$(mktemp -d)"
    (
        cd "$temp_dir"
        git clone https://aur.archlinux.org/yay-bin.git
        cd yay-bin
        makepkg -si --noconfirm
    )
    rm -rf "$temp_dir"
    success "yay installed"
}

install_packages() {
    info "Installing packages from packages.txt..."
    local packages_file="$SCRIPT_DIR/packages.txt"

    if [[ ! -f "$packages_file" ]]; then
        error "Package file not found: $packages_file"
        return 1
    fi

    # Read packages, skip comments and empty lines
    local packages
    packages=$(grep -v '^#' "$packages_file" | grep -v '^$' | tr '\n' ' ')

    # shellcheck disable=SC2086
    yay -Syu --noconfirm --needed $packages
    success "Packages installed"
}

setup_zsh_plugins() {
    info "Setting up zsh plugins..."
    local zsh_custom="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
    clone_if_missing \
        "https://github.com/zsh-users/zsh-autosuggestions" \
        "$zsh_custom/plugins/zsh-autosuggestions"
}

setup_tmux() {
    info "Setting up tmux..."
    clone_if_missing \
        "https://github.com/tmux-plugins/tpm" \
        "$HOME/.tmux/plugins/tpm"

    mkdir -p "$HOME/.config/tmux/plugins/catppuccin"
    clone_if_missing \
        "https://github.com/catppuccin/tmux.git" \
        "$HOME/.config/tmux/plugins/catppuccin/tmux" \
        "v2.1.3"
}

configure_mime_types() {
    info "Configuring MIME types..."

    # Images with imv
    local image_types=(png jpeg gif webp bmp tiff)
    for type in "${image_types[@]}"; do
        xdg-mime default imv.desktop "image/$type"
    done

    # PDFs with Evince
    xdg-mime default org.gnome.Evince.desktop application/pdf

    # Chromium as default browser
    xdg-settings set default-web-browser chromium.desktop
    xdg-mime default chromium.desktop x-scheme-handler/http
    xdg-mime default chromium.desktop x-scheme-handler/https

    # Videos with mpv
    local video_types=(
        video/mp4 video/x-msvideo video/x-matroska video/x-flv
        video/x-ms-wmv video/mpeg video/ogg video/webm video/quicktime
        video/3gpp video/3gpp2 video/x-ms-asf video/x-ogm+ogg
        video/x-theora+ogg application/ogg
    )
    for type in "${video_types[@]}"; do
        xdg-mime default mpv.desktop "$type"
    done

    success "MIME types configured"
}

configure_mise() {
    info "Configuring mise..."
    mise settings add idiomatic_version_file_enable_tools ruby
    success "mise configured"
}

configure_pam() {
    info "Configuring PAM (faillock settings)..."
    # Increase lockout limit to 10 and decrease timeout to 2 minutes
    sudo sed -i 's|^\(auth\s\+required\s\+pam_faillock.so\)\s\+preauth.*$|\1 preauth silent deny=10 unlock_time=120|' "/etc/pam.d/system-auth"
    sudo sed -i 's|^\(auth\s\+\[default=die\]\s\+pam_faillock.so\)\s\+authfail.*$|\1 authfail deny=10 unlock_time=120|' "/etc/pam.d/system-auth"
    success "PAM configured"
}

configure_docker() {
    info "Configuring Docker..."

    # Docker daemon config
    sudo mkdir -p /etc/docker
    sudo tee /etc/docker/daemon.json >/dev/null <<'EOF'
{
    "log-driver": "json-file",
    "log-opts": { "max-size": "10m", "max-file": "5" },
    "dns": ["172.17.0.1"],
    "bip": "172.17.0.1/16"
}
EOF

    # Expose systemd-resolved to Docker network
    sudo mkdir -p /etc/systemd/resolved.conf.d
    echo -e '[Resolve]\nDNSStubListenerExtra=172.17.0.1' | sudo tee /etc/systemd/resolved.conf.d/20-docker-dns.conf >/dev/null
    sudo systemctl restart systemd-resolved

    # Enable Docker service
    sudo systemctl enable docker

    # Add user to docker group
    sudo usermod -aG docker "$USERNAME"

    # Prevent Docker from blocking boot
    sudo mkdir -p /etc/systemd/system/docker.service.d
    sudo tee /etc/systemd/system/docker.service.d/no-block-boot.conf >/dev/null <<'EOF'
[Unit]
DefaultDependencies=no
EOF

    sudo systemctl daemon-reload
    success "Docker configured"
}

configure_user_groups() {
    info "Adding user to groups..."
    sudo usermod -aG dialout "$USERNAME"
    sudo usermod -aG uucp "$USERNAME"
    success "User groups configured"
}

configure_gtk() {
    info "Configuring GTK settings..."
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
    gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"

    # Fix Nautilus action icons
    sudo ln -snf /usr/share/icons/Adwaita/symbolic/actions/go-previous-symbolic.svg /usr/share/icons/Yaru/scalable/actions/go-previous-symbolic.svg
    sudo ln -snf /usr/share/icons/Adwaita/symbolic/actions/go-next-symbolic.svg /usr/share/icons/Yaru/scalable/actions/go-next-symbolic.svg
    sudo gtk-update-icon-cache /usr/share/icons/Yaru
    success "GTK configured"
}

configure_network_services() {
    info "Configuring network services..."
    sudo systemctl enable iwd.service

    # Prevent systemd-networkd-wait-online timeout on boot
    sudo systemctl disable systemd-networkd-wait-online.service
    sudo systemctl mask systemd-networkd-wait-online.service
    success "Network services configured"
}

configure_greetd() {
    info "Configuring greetd..."
    sudo cp "$REPO_DIR/etc/greetd/config.toml" /etc/greetd/config.toml
    sudo cp "$REPO_DIR/etc/greetd/regreet.toml" /etc/greetd/regreet.toml
    sudo cp "$REPO_DIR/etc/greetd/regreet.css" /etc/greetd/regreet.css
    sudo cp "$REPO_DIR/etc/pam.d/greetd" /etc/pam.d/greetd
    sudo mkdir -p /usr/share/backgrounds
    if [[ -f "$HOME/wallpapers/forest.jpg" ]]; then
        sudo cp "$HOME/wallpapers/forest.jpg" /usr/share/backgrounds/greeter.jpg
    else
        warn "Wallpaper not found: ~/wallpapers/forest.jpg"
    fi
    sudo systemctl enable greetd.service
    success "greetd configured"
}

configure_autologin() {
    info "Configuring autologin..."

    # Plymouth theme
    sudo plymouth-set-default-theme -R catppuccin-mocha

    # Bootloader timeout
    sudo tee /boot/loader/loader.conf >/dev/null <<'EOF'
timeout 0
EOF

    # Getty autologin
    sudo mkdir -p /etc/systemd/system/getty@tty1.service.d
    sudo tee /etc/systemd/system/getty@tty1.service.d/autologin.conf >/dev/null <<EOF
[Service]
ExecStart=
ExecStart=-/usr/bin/agetty -o '-p -f -- \\\\u' --skip-login --noclear --nonewline --autologin $USERNAME --noclear %I \$TERM
EOF

    success "Autologin configured"
}

sync_dotfiles() {
    info "Syncing dotfiles..."
    "$SCRIPT_DIR/sync-dotfiles"
    success "Dotfiles synced"
}

build_bat_cache() {
    info "Building bat cache..."
    if command -v bat &>/dev/null; then
        bat cache --build
        success "bat cache built"
    else
        warn "bat not found, skipping cache build"
    fi
}

main() {
    info "Starting initial setup for user: $USERNAME"
    info "Repository: $REPO_DIR"
    echo

    install_yay
    install_packages

    setup_zsh_plugins
    setup_tmux

    configure_mime_types
    configure_mise
    configure_pam
    configure_docker
    configure_user_groups
    configure_gtk
    configure_network_services

    sync_dotfiles
    build_bat_cache

    configure_greetd
    configure_autologin

    echo
    success "Initial setup complete!"
    warn "You may need to log out and back in for group changes to take effect"
    warn "Remember to add 'quiet splash' to kernel parameters in /boot/loader/entries/<entry>.conf"
}

main "$@"
